## å‘½ä»¤æ¨¡å¼

### 1ã€åŸºæœ¬æ¦‚å¿µ

å‘½ä»¤æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ï¼Œå…¶ç›®çš„æ˜¯å°†ä¸€ä¸ªè¯·æ±‚æˆ–æ“ä½œå°è£…æˆä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œä»¥ä¾¿äºåœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­ä½¿ç”¨ã€ä¼ é€’å’Œæ“ä½œã€‚

è¯¥æ¨¡å¼å®ç°äº†è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„æ¾è€¦åˆï¼Œä½¿ä½ å¯ç”¨ä¸åŒçš„è¯·æ±‚å¯¹å®¢æˆ·è¿›è¡Œå‚æ•°åŒ–ï¼›

å‘½ä»¤æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯æ”¯æŒ**è¯·æ±‚æ’é˜Ÿ**æˆ–**è®°å½•æ—¥å¿—**ï¼Œä»¥åŠ**å¯æ’¤é”€**çš„æ“ä½œã€‚

æ­£å› ä¸ºå‘½ä»¤æ¨¡å¼çš„è¿™äº›ç‰¹å¾ï¼Œè™½ä½¿å¾—å®ƒçš„ä½¿ç”¨åœºæ™¯æœ‰é™ï¼Œä½†æ˜¯ä½¿ç”¨åœºæ™¯ç‰¹åˆ«æ˜ç¡®ï¼ˆä½ ä¸ä¼šæœ‰è¯¯ç”¨æŸä¸ªè®¾è®¡æ¨¡å¼è€Œå¢åŠ ç³»ç»Ÿçš„è®¾è®¡æˆæœ¬çš„å¿ƒæ™ºè´Ÿæ‹…ï¼‰

å‘½ä»¤æ¨¡å¼çš„`UML`å›¾å¦‚ä¸‹ï¼š

<div align="center">
  <img :src="$withBase('/design-pattern/command-pattern.png')" alt="å‘½ä»¤æ¨¡å¼" />
</div>

ä¸Šè¿°è¿™ä¸ª`UML`å›¾ä¸€çœ¼çœ‹èµ·æ¥å¯èƒ½ä¼šè®©äººæ‘¸ä¸ç€å¤´è„‘ï¼Œé€ä¸€å¯¹å…¶è¿›è¡Œåˆ†æå‘ç°å…¶å®ä¹Ÿä¸éš¾ç†è§£ã€‚é¦–å…ˆï¼Œ`Client`ç±»çš„ä¾èµ–å…³ç³»å¯ä»¥ä¸ç”¨çœ‹ï¼Œå› ä¸ºå®ƒä¸æ˜¯å‘½ä»¤æ¨¡å¼çš„æ ¸å¿ƒã€‚

`Command`æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰å‘½ä»¤çš„è§„æ ¼ï¼Œä¸šåŠ¡å‘½ä»¤ç±»æ ¹æ®å…¶è´Ÿè´£çš„ä¸šåŠ¡é€»è¾‘å®ç°`Command`æ¥å£ï¼Œå®ƒçš„å†…éƒ¨éœ€è¦æŒæœ‰ä¸€ä¸ª`Receiver`ç±»çš„å®ä¾‹ï¼ˆå…³è”å…³ç³»ï¼‰ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†`Command`çš„å®ç°ç±»åœ¨æ‰§è¡Œç‰¹å®šæ“ä½œçš„æ—¶å€™ï¼Œèƒ½å¤Ÿå°†æ¶ˆæ¯æŠ¥å‘Šç»™å¤–ç•Œï¼ˆå¦‚æœä½ ä¸éœ€è¦è¿™æ ·çš„æ“ä½œï¼Œè¿™ä¸€æ­¥ä¹Ÿå¯ä»¥çœç•¥ï¼‰ï¼›

å…³é”®çš„è®¾è®¡åœ¨äº`Invoker`ç±»ï¼Œå®ƒå†…éƒ¨ç®¡ç†ç€ä¸€æ‰¹å‘½ä»¤ï¼ˆå› æ­¤`UML`å›¾ä¸­ç”¨çš„æ˜¯èšåˆå…³ç³»ï¼‰ï¼Œè€Œæˆ‘ä»¬çš„`æ’¤é”€`ï¼Œ`æ—¥å¿—è®°å½•`ï¼Œ`è¯·æ±‚æ’é˜Ÿ`ç­‰æ“ä½œå…¨éƒ¨éƒ½åœ¨äºè¿™ä¸ªç±»ä¸­è¿›è¡Œæ§åˆ¶çš„ï¼ˆä¸€èˆ¬ç”¨`é˜Ÿåˆ—`å®ç°ï¼Œå¦‚æœæœ‰å¤æ‚ä¼˜å…ˆçº§çš„å¤„ç†ï¼Œè¿˜å¯ä»¥ä½¿ç”¨`å †`è¿›è¡Œç®¡ç†ï¼‰ã€‚

### 2ã€ä»£ç ç¤ºä¾‹

```ts
/**
 * æ¶ˆæ¯é€šçŸ¥ç±»
 */
class Receiver {
  notify() {
    console.log("é€šçŸ¥æ¶ˆæ¯å·²ä¼ è¾¾~~");
  }
}

/**
 * å‘½ä»¤æ¥å£
 */
interface Command {
  action: Action;

  exec(): void;
}

/**
 * ä¸šåŠ¡å‘½ä»¤æ¥å£
 */
class CopyCommand implements Command {
  constructor(public action: Action) {}

  // #region éå¿…é¡»ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦å†³å®š
  receiver: Receiver;

  setReceiver(r: Receiver) {
    this.receiver = r;
  }
  // #endregion

  exec(): void {
    // éå¿…é¡»ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡å†³å®š
    this.receiver.notify();
    this.action.work();
  }
}

/**
 * å‘½ä»¤è°ƒç”¨è€…ï¼Œå‘½ä»¤æ¨¡å¼æ ¸å¿ƒç±»
 */
class Invoker {
  protected cmd: Command;

  setCommand(cmd: Command) {
    this.cmd = cmd;
  }

  execCommand() {
    this.cmd.exec();
  }
}

class Action {
  work() {
    console.log("å¹²æ´»å„¿");
  }
}

const copyAction = new Action();
const copyCmd = new CopyCommand(copyAction);
const invoker = new Invoker();
invoker.setCommand(copyCmd);
invoker.execCommand();
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œ`CopyCommand`çš„è¡Œä¸ºæ˜¯å¤–éƒ¨æ³¨å…¥ï¼ˆ`ä¾èµ–å€’ç½®åŸåˆ™`çš„ä½“ç°ï¼‰çš„ï¼Œå¦‚æœåœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œä½ çš„ä¸šåŠ¡åœºæ™¯å¦‚æœè¶³å¤Ÿç®€å•çš„è¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å°†è¡Œä¸ºå†…èšåˆ°ä¸šåŠ¡å‘½ä»¤æ¥å£å†…ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µçµæ´»è°ƒæ•´ã€‚

### 3ã€åœ¨å‰ç«¯ä¸­çš„å®è·µ

å‘½ä»¤æ¨¡å¼æ˜¯æˆ‘å­¦ä¹ è®¾è®¡æ¨¡å¼ä¸­å°‘æœ‰çš„ä¸€å¼€å§‹å­¦ä¹ å‰ç«¯å°±æŒæ¡çš„è®¾è®¡æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘åœ¨å®é™…å¼€å‘ä¸­åº”ç”¨äº†å¾ˆå¤šæ¬¡äº†ã€‚

æˆ‘æ‰€è´Ÿè´£çš„ä¸šåŠ¡éœ€æ±‚ï¼Œåªè¦é‡åˆ°`ç¼–è¾‘å™¨`è¿™ç±»ä¸šåŠ¡åœºæ™¯ï¼ˆå‡ ä¹éƒ½ä¼šæœ‰`æ’¤é”€`ï¼Œ`é‡åš`ç­‰éœ€æ±‚ï¼‰ï¼Œæˆ‘éƒ½ä¼šä½¿ç”¨å‘½ä»¤æ¨¡å¼è¿›è¡Œå®ç°ã€‚æˆ‘å°±ä»¥`Antv/X6`çš„`@antv/x6-plugin-history`æ’ä»¶çš„æºç ç»™å¤§å®¶ä¸¾ä¸ªä¾‹å­ã€‚

<div align="center">
  <img src="https://res.cdn.changbaimg.com/-/15105cbfb1e2d08a/antv-demo.png" alt="Antv/X6çš„demoæ¡ˆä¾‹" />
</div>

```ts
import { KeyValue, Basecoat, Model, Graph } from "@antv/x6";
import "./api";

export class History
  extends Basecoat<History.EventArgs>
  implements Graph.Plugin
{
  public name = "history";
  protected redoStack: History.Commands[];
  protected undoStack: History.Commands[];
  protected batchCommands: History.Command[] | null = null;
  protected stackSize = 0; // 0: not limit

  protected readonly handlers: (<T extends History.ModelEvents>(
    event: T,
    args: Model.EventArgs[T]
  ) => any)[] = [];

  constructor(options: History.Options = {}) {
    super();
    const { stackSize = 0 } = options;
    this.stackSize = stackSize;
  }

  undo(options: KeyValue = {}) {
    if (!this.disabled) {
      const cmd = this.undoStack.pop();
      if (cmd) {
        this.revertCommand(cmd, options);
        this.redoStack.push(cmd);
        this.notify("undo", cmd, options);
      }
    }
    return this;
  }

  redo(options: KeyValue = {}) {
    if (!this.disabled) {
      const cmd = this.redoStack.pop();
      if (cmd) {
        this.applyCommand(cmd, options);
        this.undoStackPush(cmd);
        this.notify("redo", cmd, options);
      }
    }
    return this;
  }

  clean(options: KeyValue = {}) {
    this.undoStack = [];
    this.redoStack = [];
    this.notify("clean", null, options);
    return this;
  }
  // #endregion

  protected createCommand(options?: { batch: boolean }): History.Command {
    return {
      batch: options ? options.batch : false,
      data: {} as History.CreationData,
    };
  }

  protected revertCommand(cmd: History.Commands, options?: KeyValue) {}

  protected applyCommand(cmd: History.Commands, options?: KeyValue) {}

  protected executeCommand(
    cmd: History.Command,
    revert: boolean,
    options: KeyValue
  ) {}

  protected addCommand<T extends keyof Model.EventArgs>(
    event: T,
    args: Model.EventArgs[T]
  ) {}

  protected notify(
    event: keyof History.EventArgs,
    cmd: History.Commands | null,
    options: KeyValue
  ) {}

  protected push(cmd: History.Command, options: KeyValue) {}

  protected undoStackPush(cmd: History.Commands) {}
}

export namespace History {
  export interface Command {
    batch: boolean;
    modelChange?: boolean;
    event?: ModelEvents;
    data: CreationData | ChangingData;
    options?: KeyValue;
  }
  export type Commands = History.Command[] | History.Command;
}
```

ä»¥ä¸Šä»£ç ç»è¿‡äº†èŠ‚é€‰ï¼Œå¦‚æœä½ æƒ³é˜…è¯»æºç ï¼Œå¯ä»¥æŸ¥çœ‹[æ­¤å¤„](https://github1s.com/antvis/x6/blob/HEAD/packages/x6-plugin-history/src/index.ts)

å¦å¤–ä¸€ä¸ªä¾‹å­æ˜¯æœ€è¿‘åœ¨`Promise`çš„å¤„ç†ä¸­é‡åˆ°çš„ä¸€ç‚¹å„¿å¯å‘ã€‚

å…ˆç»™å¤§å®¶æè¿°ä¸€ä¸‹éœ€æ±‚ï¼š

æˆ‘éœ€è¦åšä¸€ä¸ªéŸ³ä¹å®¡æ ¸åå°ï¼Œè¿™ä¸ªåå°çš„ç”¨æˆ·éœ€è¦åˆ¤æ–­éŸ³ä¹æ˜¯å¦æœ‰å™ªéŸ³ï¼Œæ¯ä¸ªäººä¸€å¤©è‡³å°‘è¦å®¡æ ¸å‡ åé¦–æ­Œï¼Œä¸€ä¸ªéŸ³ä¹æœ‰`20`å¤š`MB`ï¼ˆå› ä¸ºæ˜¯`wav`æ ¼å¼ï¼Œæ²¡æœ‰å‹ç¼©ï¼‰ï¼Œå¦‚æœæƒ³è®©ç”¨æˆ·åœ¨ç”¨çš„æ—¶å€™å†ä¸‹è½½çš„è¯ï¼ŒåŠ è½½éŸ³ä¹é¢„è®¡èŠ±è´¹ 1 åˆ†é’Ÿçš„æ ·å­ï¼Œä½¿ç”¨èµ·æ¥æå…¶éš¾å—ï¼›

ç”¨æˆ·æå‡ºèƒ½ä¸èƒ½å…ˆå°†å…¶ç¼“å­˜ï¼ˆæ¯”å¦‚æˆ‘ç°åœ¨éœ€è¦å»å–æ¯å’–å•¡ï¼Œæˆ‘å¯ä»¥å…ˆå°†ä¸€ç³»åˆ—çš„èµ„æºç¼“å­˜ä¸‹æ¥ï¼Œä¸€ä¼šå„¿å›æ¥ä¹‹åï¼Œæˆ‘å†å¤„ç†ï¼Œå°†ä¼šæ˜¯ç§’å¼€ï¼Œå·¥ä½œç”Ÿæ´»ä¸¤ä¸è¯¯ï¼‰ï¼Œä¸ºäº†è®©ç”¨æˆ·å®ç°ä¸€é”®ç¼“å­˜çš„æ•ˆæœï¼ˆå¦‚æœè®©ç”¨æˆ·ä¸€ä¸ªä¸€ä¸ªçš„ç‚¹ï¼Œé‚£å¾—æŠŠå¼€å‘éª‚æ­»ğŸ˜‚ï¼‰ï¼Œæ­¤æ—¶ä¸ç®¡ä»–æœ‰å¤šå°‘å¾…å®¡æ ¸çš„ï¼Œè‚¯å®šæ˜¯è¦å…¨éƒ¨ç¼“å­˜å®Œçš„ï¼Œè¿™ç§åœºæ™¯è‚¯å®šæ˜¯è¦æ§åˆ¶å¹¶å‘é‡çš„ï¼Œå¦åˆ™ç”¨èµ·æ¥ç›¸å½“çš„å¡é¡¿ï¼Œå› æ­¤ä¼šå¼•å…¥é˜Ÿåˆ—çš„è®¾è®¡ï¼›

ä½†æ˜¯è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘é¡µé¢ä¸Šå¯èƒ½è¿˜æœ‰å…¶å®ƒå¼‚æ­¥è¯·æ±‚ï¼Œç¼“å­˜éŸ³ä¹å¯¹äºæˆ‘æ¥è¯´æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§ä¸æ˜¯é‚£ä¹ˆé«˜çš„æ“ä½œï¼Œå¯¹äºå…¶å®ƒå¼‚æ­¥è¯·æ±‚ï¼Œå¯ä»¥å°†å…¶åŒ…è£¹æˆå¼‚æ­¥ä»»åŠ¡æ”¾åœ¨ä»»åŠ¡é˜Ÿåˆ—çš„å‰é¢å»å¤„ç†ï¼›

æ¥ç€åˆæœ‰ä¸€ä¸ªæ–°é—®é¢˜ï¼Œå¦‚æœè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œä½†æ˜¯æˆ‘æ­¤æ—¶æƒ³è¦æ’¤é”€ï¼ˆæ¯”å¦‚ä¸€è¿›æ¥åŠ è½½ç”¨æˆ·çš„å·²å®¡æ ¸æ•°æ®ï¼Œè™½ç„¶ç”¨æˆ·ä¸æ˜¯é©¬ä¸Šå°±è¦çœ‹ï¼Œç”¨æˆ·å®¡æ ¸ä¹‹åï¼Œéœ€è¦é‡æ–°æ‹‰å–å·²å®¡æ ¸çš„æ•°æ®ï¼‰ï¼Œé¿å…é‡å¤æ‰§è¡Œã€‚

å¼€å§‹æ—¶ï¼Œæˆ‘åšäº†åŠ›æ‰£çš„è¿™é“é¢˜ï¼Œ[design-cancellable-function](https://leetcode.cn/problems/design-cancellable-function/)ï¼Œäºæ˜¯æˆ‘å°±åœ¨æƒ³èƒ½ä¸èƒ½è®©å¼‚æ­¥å‡½æ•°ä¹Ÿèƒ½å–æ¶ˆï¼Ÿä½†æ˜¯å¼‚æ­¥å‡½æ•°è·Ÿ`Generator`å‡½æ•°çº¦å®šæ¯æ­¥è¿”å›ä¸€ä¸ª`Promise`è¿™ç§åœºæ™¯æœ‰ä¸ªå¾ˆå¤§çš„åŒºåˆ«ï¼Œå¼‚æ­¥å‡½æ•°æ˜¯è‡ªæ‰§è¡Œæ“ä½œï¼Œå¦‚æœæƒ³å–æ¶ˆï¼Œåªèƒ½å–æ¶ˆæ•´ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å¦‚æœå‡è®¾ä¸­é—´ä¸€æ—¦æœ‰å¤šä¸ªä¸²è¡Œçš„å¼‚æ­¥ä»»åŠ¡ï¼Œä¸€æ—¦å¼€å§‹ä¹Ÿå°±å†ä¹Ÿæ§åˆ¶ä¸äº†äº†ã€‚

æ‰€ä»¥ï¼Œå¯¹äºå¼‚æ­¥å‡½æ•°æœ¬èº«çš„æ”¹é€ æ— æ³•åšåˆ°ï¼Œé‚£å°±åªèƒ½å€ŸåŠ©è®¾è®¡æ¨¡å¼ï¼Œæ€è€ƒä¸€ä¸‹å‰é¢æåˆ°çš„å…³é”®è¯ï¼š`å¹¶å‘æ§åˆ¶`ï¼Œ`é˜Ÿåˆ—`ï¼Œ`ä¼˜å…ˆçº§`ï¼Œ`å¯æ’¤é”€`ï¼Œæ¯«æ— ç–‘é—®ï¼Œè¿™ä¸ªåœºæ™¯å°±æ˜¯å‘½ä»¤æ¨¡å¼çš„ç»ä½³ç”¨æ­¦ä¹‹åœ°ã€‚

ä»¥ä¸‹æ˜¯ä¸Šè¿°éœ€æ±‚çš„å®ç°ï¼Œç¯‡å¹…æœ‰é™ï¼Œæ²¡æœ‰å°†ä¸šåŠ¡ä»£ç ç»™å¤§å®¶å±•ç¤ºã€‚

é¦–å…ˆæ˜¯å¯¹äºä¸€ä¸ªå¯å–æ¶ˆä»»åŠ¡çš„è®¾è®¡ï¼Œè¿™ä¸ªéƒ¨åˆ†ï¼Œå°±ç›¸å½“äºæ˜¯å‘½ä»¤æ¨¡å¼ä¸­çš„å‘½ä»¤èŠ‚ç‚¹ï¼Œä½†æˆ‘å¹¶æ²¡æœ‰å°†å…¶å‘½åä¸º`XxxCommand`

```ts
// å–æ¶ˆåŸå› å“¨å…µå¯¹è±¡ï¼Œä½¿å¾—è°ƒç”¨æ–¹å¯ä»¥æ˜ç¡®çŸ¥é“æ˜¯å–æ¶ˆè€Œéé”™è¯¯ä¿¡æ¯
const CancelledReason = Symbol("Async task has been cancelled");
/**
 * å¯å–æ¶ˆçš„ä»»åŠ¡
 */
interface CancellableTask<T> {
  /**
   * å¼‚æ­¥æ“ä½œæ‰§è¡Œå‡½æ•°
   * @param args
   * @returns
   */
  action: (...args: any[]) => Promise<T>;
  /**
   * å–æ¶ˆä»»åŠ¡
   * @returns
   */
  cancel: () => void;
}

/**
 * å°†ä¸€ä¸ªæ™®é€šä»»åŠ¡åŒ…è£¹æˆä¸€ä¸ªå¯å–æ¶ˆçš„ä»»åŠ¡
 * @param fn æ™®é€šä»»åŠ¡
 * @param args æ™®é€šä»»åŠ¡çš„é¢„è®¾å‚æ•°
 * @returns
 */
function createCancellableTask<T>(
  fn: (...args: any[]) => T | Promise<T>,
  ...args: any[]
): CancellableTask<T> {
  let trigger: ((reason?: any) => void) | null = null;
  let isCancel = false;
  const action = () => {
    // å¦‚æœåœ¨actionæ–¹æ³•è°ƒç”¨ä¹‹å‰å°±å·²ç»è°ƒç”¨ï¼Œé‚£ä¹ˆæ­¤åˆ»ç›´æ¥è¿”å›ä¸€ä¸ªå–æ¶ˆçš„Promise
    if (isCancel) {
      return Promise.reject(CancelledReason);
    }
    // éƒ¨ç½²çœŸæ­£çš„å¼‚æ­¥ä»»åŠ¡ï¼Œè‹¥åœ¨å¼‚æ­¥ä»»åŠ¡æœªå®Œæˆä¹‹å‰å–æ¶ˆï¼Œåˆ™è¿”å›å–æ¶ˆçš„åŸå› ï¼Œå¦åˆ™å–æœ€ç»ˆçš„ç»“æœä½œä¸ºPromiseçš„ç»“æœ
    return new Promise<T>((resolve, reject) => {
      trigger = reject;
      Promise.resolve(fn(...args))
        .then(resolve)
        .catch(reject);
    });
  };
  const cancel: () => void = () => {
    isCancel = true;
    typeof trigger === "function" && trigger(CancelledReason);
  };
  return {
    action,
    cancel,
  };
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œ**ä¸ºä»€ä¹ˆ`createCancellableTask`å‡½æ•°è¦è®¾è®¡æˆè¿™ä¸ªæ ·å­ï¼Œå…¶å®å€Ÿé‰´äº†`JS`çš„`call`å’Œ`apply`å‡½æ•°çš„è®¾è®¡**ï¼Œäº‹å…ˆå°†å‡½æ•°çš„å‚æ•°é¢„è®¾ï¼Œå› ä¸ºåé¢è°ƒç”¨è€…å†è€ƒè™‘å‚æ•°ï¼Œå¤„ç†èµ·æ¥å°±éš¾å—ï¼Œå¹¶ä¸”è¿˜ä¼šå’Œä»»åŠ¡è°ƒåº¦å™¨çš„å¤„ç†é€»è¾‘è€¦åˆï¼Œå¾—ä¸å¿å¤±ï¼Œè¿™æ ·çš„è®¾è®¡å¯ä»¥æå¤§ç®€åŒ–ä»»åŠ¡è°ƒåº¦å™¨çš„è´Ÿæ‹…ã€‚

æ¥ç€æ˜¯ä»»åŠ¡è°ƒåº¦å™¨ï¼Œå¯ä»¥å°†å…¶è§†ä¸ºå‘½ä»¤æ¨¡å¼ç¤ºä¾‹`UML`ä¸­çš„`Invoker`ç±»ï¼Œè¿™ä¸ªä»£ç æ”¹é€ è‡ª[æ­¤å¤„](/javascript/write/async-task-scheduler.html)

```ts
interface AsyncTaskNode<T> {
  // ä¿å­˜è¿”å›çš„Promiseçš„resolveè§¦å‘å™¨
  resolve: (value: T) => void;
  // ä¿å­˜è¿”å›çš„Promiseçš„rejectè§¦å‘å™¨
  reject: (reason: any) => void;
  // ä»»åŠ¡çœŸå®èŠ‚ç‚¹
  cancellableTask: CancellableTask<T>;
}

type InsertAction = "push" | "unshift";

class AsyncTaskScheduler<T> {
  /**
   * å®šä¹‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡
   */
  private runningTask = 0;
  /**
   * å®šä¹‰ä»»åŠ¡è°ƒåº¦å™¨å…è®¸çš„æœ€å¤§å¼‚æ­¥å¹¶å‘é‡
   */
  private maxTask = 5;
  /**
   * å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºè®°å½•æš‚æ—¶æ— æ³•å¤„ç†ç¨å€™éœ€è¦å¤„ç†çš„å†…å®¹
   */
  private asyncTaskQueue: AsyncTaskNode<T>[] = [];
  /**
   * å®šä¹‰æ–¹æ³•ï¼Œä¾›å¤–ç•Œä»»åŠ¡å†…å®¹åŠ å…¥åˆ°å½“å‰çš„è°ƒåº¦å™¨ä¸­æ‰§è¡Œ
   */
  add(cancellableTask: CancellableTask<T>, ac: InsertAction = "push") {
    return new Promise((resolve, reject) => {
      if (this.runningTask < this.maxTask) {
        this.runningTask++;
        const { action } = cancellableTask;
        action()
          .then((response) => {
            this.runningTask--;
            resolve(response);
            this.run();
          })
          .catch((err) => {
            this.runningTask--;
            reject(err);
            this.run();
          });
      } else {
        this.asyncTaskQueue[ac]({
          resolve,
          reject,
          cancellableTask,
        });
      }
    });
  }

  /**
   * ä¼˜å…ˆæ’å…¥çš„ä»»åŠ¡
   * @param cancellableTask
   */
  addFirst(cancellableTask: CancellableTask<T>) {
    this.add(cancellableTask, "unshift");
  }

  private run() {
    while (this.asyncTaskQueue.length && this.runningTask < this.maxTask) {
      const task = this.asyncTaskQueue.shift();
      const { cancellableTask, reject, resolve } = task!;
      const { action } = cancellableTask;
      this.runningTask++;
      action()
        .then((response) => {
          this.runningTask--;
          resolve(response);
          this.run();
        })
        .catch((err) => {
          this.runningTask--;
          reject(err);
          this.run();
        });
    }
  }
}
```

æœ€åæ˜¯ä¸Šè¿°ä»£ç çš„å•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼š

```ts
function printMsg(msg: string) {
  return new Promise<string>((resolve) => {
    setTimeout(() => {
      resolve(msg);
    }, 3000);
  });
}

function errorMsg(msg: string) {
  return new Promise<string>((resolve, reject) => {
    setTimeout(() => {
      reject(msg);
    }, 3000);
  });
}

describe("error", () => {
  let task: CancellableTask<string>;
  let scheduler: AsyncTaskScheduler<string>;

  beforeEach(() => {
    task = createCancellableTask<string>(errorMsg, "hello world");
    scheduler = new AsyncTaskScheduler<string>();
  });

  it("test command 1", (done) => {
    const p = scheduler.add(task);

    p.then((resp) => {
      console.log(resp);
    }).catch((reason) => {
      done();
      expect(reason).toBe(CancelledReason);
    });

    setTimeout(() => {
      task.cancel();
    }, 300);
  });

  it("test command 2", (done) => {
    const now = Date.now();
    const p = scheduler.add(task);

    p.catch((err) => {
      console.log(Date.now() - now);
      done();
      expect(err).toBe("hello world");
    });
  });
});

describe("success", () => {
  let task: CancellableTask<string>;
  let scheduler: AsyncTaskScheduler<string>;

  beforeEach(() => {
    task = createCancellableTask<string>(printMsg, "hello world");
    scheduler = new AsyncTaskScheduler<string>();
  });

  it("test command 1", (done) => {
    const p = scheduler.add(task);

    p.then((resp) => {
      console.log(resp);
    }).catch((reason) => {
      done();
      expect(reason).toBe(CancelledReason);
    });

    setTimeout(() => {
      task.cancel();
    }, 300);
  });

  it("test command 2", (done) => {
    const now = Date.now();
    const p = scheduler.add(task);

    p.then((resp) => {
      console.log(Date.now() - now);
      done();
      expect(resp).toBe("hello world");
    });
  });

  it("test command 3", (done) => {
    const now = Date.now();
    const p = scheduler.add(task);

    p.catch((err) => {
      console.log(Date.now() - now);
      expect(err).toBe(CancelledReason);
      done();
    });

    task.cancel();
  });

  it("test command 4", (done) => {
    const now = Date.now();
    const p = scheduler.add(task);

    p.then((resp) => {
      console.log(Date.now() - now);
      expect(resp).toBe("hello world");
      done();
    });

    setTimeout(() => {
      task.cancel();
    }, 4000);
  });
});
```

æœ€åï¼Œéœ€è¦è¡¥å……çš„ä¸€ç‚¹æ˜¯ï¼Œä¸Šè¿°çš„è®¾è®¡å¹¶**æ²¡æœ‰ä¾µå…¥ä¸šåŠ¡ä»£ç ï¼Œä¸šåŠ¡ä»£ç ä»ç„¶å…·æœ‰`åŸå­æ€§`**ï¼Œå³ä¸€æ—¦**æŸä¸ªä»»åŠ¡å¼€å§‹åšäº†ï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚å·²ç»å‘é€å‡ºå»äº†ï¼Œé‚£å°±çœŸçš„å‘å‡ºå»äº†ï¼Œè¿™ä¸ªæ˜¯æ— æ³•å–æ¶ˆçš„ï¼Œå–æ¶ˆæ“ä½œçœŸæ­£å–æ¶ˆçš„æ˜¯å¤–ç•Œä¸å†å¤„ç†è¿™ä¸ªæ“ä½œçš„åç»­ç»“æœ**ã€‚
